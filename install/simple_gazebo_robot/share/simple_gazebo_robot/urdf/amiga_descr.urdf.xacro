<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="husky_22">

  <!-- Parametros -->
  <xacro:property name="wheel_radius" value="0.17775" />
  <xacro:property name="wheel_width" value="0.1143" />
  <xacro:property name="wheel_separation" value="0.5709" />
  <xacro:property name="wheel_diameter" value="0.3555" />
  <xacro:property name="base_mass" value="33.855" />
  <xacro:property name="wheel_mass" value="2.6357" />

  <!-- ===================== BASE LINK ===================== -->
  <link name="base_link">
    <inertial>
      <mass value="${base_mass}" />
      <origin xyz="-0.085613 -0.00084 0.238145" rpy="0 0 0" />
      <inertia ixx="2.2343" ixy="0" ixz="0.275174" iyy="3.42518" iyz="0.00239624" izz="2.1241" />
    </inertial>

    <visual name="base">
      <origin xyz="0 0 0" rpy="0 0 1.567" />
      <geometry>
        <mesh filename="package://simple_gazebo_robot/mesh/chassi.dae" scale="0.005 0.005 0.005" />
      </geometry>
      <material name="flat_black">
        <color rgba="0.1 0.1 0.1 1" />
      </material>
    </visual>

    <collision name="collision">

      <origin xyz="0 0 0.1" rpy="0 0 0" />
      <geometry>
        <box size="1.8 2.5 0.2" />
      </geometry>
    </collision>
  </link>

  <!-- ===================== BACK LEFT WHEEL ===================== -->
  <link name="back_left_wheel">
    <inertial>
      <mass value="${wheel_mass}" />
      <origin xyz="0 0 0" rpy="0 0 0" />
      <inertia ixx="0.0246688" ixy="0" ixz="0" iyy="0.0246688" iyz="0" izz="0.0441058" />
    </inertial>

    <visual name="back_left_wheel">
      <origin xyz="0 0 0" rpy="-3.14159 0 0" />
      <geometry>
        <mesh filename="package://simple_gazebo_robot/mesh/roda.dae" scale="0.005 0.005 0.005" />
      </geometry>
      <material name="grey">
        <color rgba="0.7 0.7 0.7 1" />
      </material>
    </visual>

    <collision name="back_left_wheel_collision">
      <origin xyz="0 0 0" rpy="-1.5707 0 0" />
      <geometry>
        <cylinder radius="${wheel_radius}" length="${wheel_width}" />
      </geometry>
    </collision>
  </link>

  <!-- ===================== BACK RIGHT WHEEL ===================== -->
  <link name="back_right_wheel">
    <inertial>
      <mass value="${wheel_mass}" />
      <origin xyz="0 0 0" rpy="0 0 0" />
      <inertia ixx="0.0246688" ixy="0" ixz="0" iyy="0.0246688" iyz="0" izz="0.0441058" />
    </inertial>

    <visual name="back_right_wheel">
      <origin xyz="0 0 0" rpy="-3.14159 0 0" />
      <geometry>
        <mesh filename="package://simple_gazebo_robot/mesh/roda.dae" scale="0.005 0.005 0.005" />
      </geometry>
      <material name="grey">
        <color rgba="0.7 0.7 0.7 1" />
      </material>
    </visual>

    <collision name="back_right_wheel_collision">
      <origin xyz="0 0 0" rpy="-1.5707 0 0" />
      <geometry>
        <cylinder radius="${wheel_radius}" length="${wheel_width}" />
      </geometry>
    </collision>
  </link>

  <!-- ===================== FRONT LEFT WHEEL ===================== -->
  <link name="front_left_wheel">
    <inertial>
      <mass value="${wheel_mass}" />
      <origin xyz="0 0 0" rpy="0 0 0" />
      <inertia ixx="0.0246688" ixy="0" ixz="0" iyy="0.0246688" iyz="0" izz="0.0441058" />
    </inertial>

    <visual name="front_left_wheel">
      <origin xyz="0 0 0" rpy="-3.14159 0 0" />
      <geometry>
        <mesh filename="package://simple_gazebo_robot/mesh/roda.dae" scale="0.005 0.005 0.005" />
      </geometry>
      <material name="grey">
        <color rgba="0.7 0.7 0.7 1" />
      </material>
    </visual>

    <collision name="front_left_wheel_collision">
      <origin xyz="0 0 0" rpy="-1.5707 0 0" />
      <geometry>
        <cylinder radius="${wheel_radius}" length="${wheel_width}" />
      </geometry>
    </collision>
  </link>

  <!-- ===================== FRONT RIGHT WHEEL ===================== -->
  <link name="front_right_wheel">
    <inertial>
      <mass value="${wheel_mass}" />
      <origin xyz="0 0 0" rpy="0 0 0" />
      <inertia ixx="0.0246688" ixy="0" ixz="0" iyy="0.0246688" iyz="0" izz="0.0441058" />
    </inertial>

    <visual name="front_right_wheel">
      <origin xyz="0 0 0" rpy="-3.14159 0 0" />
      <geometry>
        <mesh filename="package://simple_gazebo_robot/mesh/roda.dae" scale="0.005 0.005 0.005" />
      </geometry>
      <material name="grey">
        <color rgba="0.7 0.7 0.7 1" />
      </material>
    </visual>

    <collision name="front_right_wheel_collision">
      <origin xyz="0 0 0" rpy="-1.5707 0 0" />
      <geometry>
        <cylinder radius="${wheel_radius}" length="${wheel_width}" />
      </geometry>
    </collision>
  </link>

  <!-- ===================== JOINTS ===================== -->
  <joint name="back_left_joint" type="continuous">
    <parent link="base_link" />
    <child link="back_left_wheel" />
    <origin xyz="-0.554793 1.09929 0.035" rpy="0 0 0" />
    <axis xyz="0 1 0" />
  </joint>

  <joint name="back_right_joint" type="continuous">
    <parent link="base_link" />
    <child link="back_right_wheel" />
    <origin xyz="-0.58474 -1.05289 0.035" rpy="0 0 0" />
    <axis xyz="0 1 0" />
  </joint>

  <joint name="front_left_joint" type="continuous">
    <parent link="base_link" />
    <child link="front_left_wheel" />
    <origin xyz="0.606687 1.07363 0.035" rpy="0 0 0" />
    <axis xyz="0 1 0" />
  </joint>

  <joint name="front_right_joint" type="continuous">
    <parent link="base_link" />
    <child link="front_right_wheel" />
    <origin xyz="0.571811 -1.05533 0.052809" rpy="0 0 0" />
    <axis xyz="0 1 0" />
  </joint>

  <!-- ===================== GAZEBO PLUGINS ===================== -->
  <gazebo>
    <plugin filename="libignition-gazebo-diff-drive-system.so"
      name="ignition::gazebo::systems::DiffDrive">
      <left_joint>back_left_joint</left_joint>
      <left_joint>front_left_joint</left_joint>
      <right_joint>back_right_joint</right_joint>
      <right_joint>front_right_joint</right_joint>
      <wheel_separation>0.5709</wheel_separation>
      <wheel_radius>0.17775</wheel_radius>
      <odom_publish_frequency>50</odom_publish_frequency>
      <topic>/cmd_vel</topic>
      <odom_topic>odom</odom_topic>
    </plugin>
  </gazebo>

  <!-- ===================== GAZEBO MATERIALS ===================== -->
  <gazebo reference="base_link">
    <material>Gazebo/FlatBlack</material>
  </gazebo>

  <gazebo reference="back_left_wheel">
    <material>Gazebo/Grey</material>
    <mu1>100000</mu1>
    <mu2>100000</mu2>
  </gazebo>

  <gazebo reference="back_right_wheel">
    <material>Gazebo/Grey</material>
    <mu1>100000</mu1>
    <mu2>100000</mu2>
  </gazebo>

  <gazebo reference="front_left_wheel">
    <material>Gazebo/Grey</material>
    <mu1>100000</mu1>
    <mu2>100000</mu2>
  </gazebo>

  <gazebo reference="front_right_wheel">
    <material>Gazebo/Grey</material>
    <mu1>100000</mu1>
    <mu2>100000</mu2>
  </gazebo>

  <!-- ===================== SENSOR MAST (BARRA VERTICAL) ===================== -->
  <!-- Barra vertical de 40cm para montar sensores -->
  <link name="sensor_mast">
    <inertial>
      <mass value="0.5" />
      <inertia ixx="0.002" ixy="0" ixz="0" iyy="0.002" iyz="0" izz="0.0005" />
    </inertial>

    <visual name="mast_visual">
      <geometry>
        <cylinder length="0.70" radius="0.02" />  <!-- 70cm altura, 4cm diâmetro -->
      </geometry>
      <material name="mast_material">
        <color rgba="0.3 0.3 0.3 1" />  <!-- Cinza metálico -->
      </material>
    </visual>

    <collision name="mast_collision">
      <geometry>
        <cylinder length="0.40" radius="0.02" />
      </geometry>
    </collision>
  </link>

  <!-- Joint da barra no centro do chassi, 70cm de altura -->
  <joint name="sensor_mast_joint" type="fixed">
    <parent link="base_link" />
    <child link="sensor_mast" />
    <origin xyz="0.20 0.0 0.70" rpy="0 0.2 0.0" />  <!-- Centro do robô, 70cm altura -->
  </joint>

  <!-- ===================== CÂMERA FRONTAL (OAK-D) ===================== -->
  <link name="front_camera_link">
    <inertial>
      <mass value="0.15" />
      <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.0001" iyz="0" izz="0.0001" />
    </inertial>

    <visual name="front_camera_visual">
      <geometry>
        <box size="0.11 0.065 0.035" />  <!-- Dimensões OAK-D -->
      </geometry>
      <material name="camera_material">
        <color rgba="0.1 0.1 0.1 1" />  <!-- Preto -->
      </material>
    </visual>

    <collision name="front_camera_collision">
      <geometry>
        <box size="0.11 0.065 0.035" />
      </geometry>
    </collision>
  </link>

  <!-- Câmera frontal montada à frente da barra, no topo -->
  <joint name="front_camera_joint" type="fixed">
    <parent link="sensor_mast" />
    <child link="front_camera_link" />
    <origin xyz="0.15 0.0 0.31" rpy="0 0 0" />  <!-- 15cm à frente, no topo da barra -->
  </joint>

  <!-- ===================== CÂMERA TRASEIRA (OAK-D) ===================== -->
  <link name="rear_camera_link">
    <inertial>
      <mass value="0.15" />
      <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.0001" iyz="0" izz="0.0001" />
    </inertial>

    <visual name="rear_camera_visual">
      <geometry>
        <box size="0.11 0.065 0.035" />
      </geometry>
      <material name="camera_material">
        <color rgba="0.1 0.1 0.1 1" />
      </material>
    </visual>

    <collision name="rear_camera_collision">
      <geometry>
        <box size="0.11 0.065 0.035" />
      </geometry>
    </collision>
  </link>

  <!-- Câmera traseira montada atrás da barra, no topo -->
  <joint name="rear_camera_joint" type="fixed">
    <parent link="sensor_mast" />
    <child link="rear_camera_link" />
    <origin xyz="-0.15 0.0 0.31" rpy="3.14159 3.14159 3.14159" />  <!-- 15cm atrás, rotacionada 180°
    para não olhar o GPS -->
  </joint>

  <!-- ===================== GPS ANTENNA ===================== -->
  <link name="gps_link">
    <inertial>
      <mass value="0.05" />
      <inertia ixx="0.00001" ixy="0" ixz="0" iyy="0.00001" iyz="0" izz="0.00001" />
    </inertial>

    <visual name="gps_visual">
      <geometry>
        <cylinder length="0.02" radius="0.05" />  <!-- Antena GPS compacta -->
      </geometry>
      <material name="gps_material">
        <color rgba="1.0 0.8 0.0 1" />  <!-- Dourado -->
      </material>
    </visual>

    <collision name="gps_collision">
      <geometry>
        <cylinder length="0.02" radius="0.05" />
      </geometry>
    </collision>
  </link>

  <!-- GPS no centro da barra, no topo -->
  <joint name="gps_joint" type="fixed">
    <parent link="sensor_mast" />
    <child link="gps_link" />
    <origin xyz="0.0 0.0 0.31" rpy="0 0 0" />  <!-- Centro da barra, topo -->
  </joint>

  <!-- ===================== COMPATIBILIDADE (oak_d_link) ===================== -->
  <!-- Link de compatibilidade para manter código existente funcionando -->
  <link name="oak_d_link">
    <inertial>
      <mass value="0.001" />  <!-- Mass mínima para não afetar dinâmica -->
      <inertia ixx="0.000001" ixy="0" ixz="0" iyy="0.000001" iyz="0" izz="0.000001" />
    </inertial>
  </link>

  <!-- Joint de compatibilidade - referencia a câmera frontal -->
  <joint name="oak_d_joint" type="fixed">
    <parent link="front_camera_link" />
    <child link="oak_d_link" />
    <origin xyz="0.0 0.0 0.0" rpy="0 0 0" />
  </joint>

  <!-- ===================== CÂMERA FRONTAL (OAK0) ===================== -->
  <gazebo reference="front_camera_link">
    <sensor name="oak0_camera" type="camera">
      <always_on>true</always_on>
      <update_rate>30</update_rate>
      <visualize>true</visualize>
      <pose>0 0 0 0 0 0</pose>  <!-- Orientada para frente -->

      <camera>
        <horizontal_fov>1.396</horizontal_fov>  <!-- ~80 graus -->
        <image>
          <width>1280</width>
          <height>800</height>
          <format>R8G8B8</format>
        </image>
        <clip>
          <near>0.1</near>
          <far>100</far>
        </clip>
        <distortion>
          <k1>0.05</k1>
          <k2>0.0</k2>
          <k3>0.0</k3>
          <p1>0.0</p1>
          <p2>0.0</p2>
        </distortion>
      </camera>
    </sensor>
  </gazebo>

  <!-- ===================== CÂMERA TRASEIRA (OAK1) ===================== -->
  <gazebo reference="rear_camera_link">
    <sensor name="oak1_camera" type="camera">
      <always_on>true</always_on>
      <update_rate>30</update_rate>
      <visualize>true</visualize>
      <pose>0 0 0 0 0 3.14159</pose>  <!-- Orientada para trás (180°) -->

      <camera>
        <horizontal_fov>1.396</horizontal_fov>  <!-- ~80 graus -->
        <image>
          <width>1280</width>
          <height>800</height>
          <format>R8G8B8</format>
        </image>
        <clip>
          <near>0.1</near>
          <far>100</far>
        </clip>
        <distortion>
          <k1>0.05</k1>
          <k2>0.0</k2>
          <k3>0.0</k3>
        </distortion>
      </camera>
    </sensor>
  </gazebo>

  <!-- ===================== CÂMERA FRONTAL DEPTH ===================== -->
  <gazebo reference="front_camera_link">
    <sensor name="oak0_depth" type="depth">
      <always_on>true</always_on>
      <update_rate>30</update_rate>
      <visualize>true</visualize>
      <pose>0 0 0 0 0 0</pose>

      <camera>
        <horizontal_fov>1.396</horizontal_fov>
        <image>
          <width>1280</width>
          <height>800</height>
          <format>R_FLOAT32</format>
        </image>
        <clip>
          <near>0.1</near>
          <far>1</far>
        </clip>
      </camera>
    </sensor>
  </gazebo>

  <!-- ===================== CÂMERA TRASEIRA DEPTH ===================== -->
  <gazebo reference="rear_camera_link">
    <sensor name="oak1_depth" type="depth">
      <always_on>true</always_on>
      <update_rate>30</update_rate>
      <visualize>true</visualize>
      <pose>0 0 0 0 0 3.14159</pose>

      <camera>
        <horizontal_fov>1.396</horizontal_fov>
        <image>
          <width>1280</width>
          <height>800</height>
          <format>R_FLOAT32</format>
        </image>
        <clip>
          <near>0.1</near>
          <far>1</far>
        </clip>
      </camera>
    </sensor>
  </gazebo>

  <!-- ===================== SENSOR GPS ===================== -->
  <gazebo reference="gps_link">
    <sensor name="gps_sensor" type="gps">
      <always_on>true</always_on>
      <update_rate>10</update_rate>
      <pose>0 0 0 0 0 0</pose>

      <gps>
        <position_sensing>
          <horizontal>
            <noise type="gaussian">
              <mean>0.0</mean>
              <stddev>0.1</stddev>  <!-- 10cm precisão -->
            </noise>
          </horizontal>
          <vertical>
            <noise type="gaussian">
              <mean>0.0</mean>
              <stddev>0.2</stddev>  <!-- 20cm precisão vertical -->
            </noise>
          </vertical>
        </position_sensing>
        <velocity_sensing>
          <horizontal>
            <noise type="gaussian">
              <mean>0.0</mean>
              <stddev>0.05</stddev>
            </noise>
          </horizontal>
          <vertical>
            <noise type="gaussian">
              <mean>0.0</mean>
              <stddev>0.1</stddev>
            </noise>
          </vertical>
        </velocity_sensing>
      </gps>
    </sensor>
  </gazebo>

  <!-- ===================== FRAMES ÓPTICOS CÂMERA FRONTAL ===================== -->
  <link name="front_camera_left_optical" />
  <joint name="front_camera_left_optical_joint" type="fixed">
    <parent link="front_camera_link" />
    <child link="front_camera_left_optical" />
    <origin xyz="0.03 0.035 0" rpy="${-pi/2} 0 ${-pi/2}" />
  </joint>

  <link name="front_camera_right_optical" />
  <joint name="front_camera_right_optical_joint" type="fixed">
    <parent link="front_camera_link" />
    <child link="front_camera_right_optical" />
    <origin xyz="0.03 -0.035 0" rpy="${-pi/2} 0 ${-pi/2}" />
  </joint>

  <link name="front_camera_depth_optical" />
  <joint name="front_camera_depth_optical_joint" type="fixed">
    <parent link="front_camera_link" />
    <child link="front_camera_depth_optical" />
    <origin xyz="0.03 0.0 0" rpy="${-pi/2} 0 ${-pi/2}" />
  </joint>

  <!-- ===================== FRAMES ÓPTICOS CÂMERA TRASEIRA ===================== -->
  <link name="rear_camera_left_optical" />
  <joint name="rear_camera_left_optical_joint" type="fixed">
    <parent link="rear_camera_link" />
    <child link="rear_camera_left_optical" />
    <origin xyz="0.03 0.035 0" rpy="${-pi/2} 0 ${pi/2}" />  <!-- Invertido para trás -->
  </joint>

  <link name="rear_camera_right_optical" />
  <joint name="rear_camera_right_optical_joint" type="fixed">
    <parent link="rear_camera_link" />
    <child link="rear_camera_right_optical" />
    <origin xyz="0.03 -0.035 0" rpy="${-pi/2} 0 ${pi/2}" />  <!-- Invertido para trás -->
  </joint>

  <link name="rear_camera_depth_optical" />
  <joint name="rear_camera_depth_optical_joint" type="fixed">
    <parent link="rear_camera_link" />
    <child link="rear_camera_depth_optical" />
    <origin xyz="0.03 0.0 0" rpy="${-pi/2} 0 ${pi/2}" />  <!-- Invertido para trás -->
  </joint>

  <!-- ===================== FRAMES ÓPTICOS COMPATIBILIDADE ===================== -->
  <!-- Mantém frames originais para compatibilidade -->
  <link name="oak_d_left_optical" />
  <joint name="oak_d_left_optical_joint" type="fixed">
    <parent link="front_camera_link" />
    <child link="oak_d_left_optical" />
    <origin xyz="0.03 0.035 0" rpy="${-pi/2} 0 ${-pi/2}" />
  </joint>

  <link name="oak_d_right_optical" />
  <joint name="oak_d_right_optical_joint" type="fixed">
    <parent link="front_camera_link" />
    <child link="oak_d_right_optical" />
    <origin xyz="0.03 -0.035 0" rpy="${-pi/2} 0 ${-pi/2}" />
  </joint>

  <link name="oak_d_depth_optical" />
  <joint name="oak_d_depth_optical_joint" type="fixed">
    <parent link="front_camera_link" />
    <child link="oak_d_depth_optical" />
    <origin xyz="0.03 0.0 0" rpy="${-pi/2} 0 ${-pi/2}" />
  </joint>

</robot>